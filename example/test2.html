<html>
    <body>
        <div id="outer">
            This text is outside the nest
            <div id="inner">
                This text is inside the nest
            </div>
        </div>
        <!-- <button id="cleanup">Cleanup</button> -->
        <script>
            function highlightButtonHandler(e) {
                var textString = document.getElementById("universalRegexInput").value;

                if(window.highLightedText != undefined) {
                    cleanupRegex(undefined);
                }
                window.highLightedText = textString;
                highlightText(textString);
            }


            function cleanupRegex (e) {
                var all = document.getElementsByTagName("*");
                var editCount = 0;
                for (var i=0; i < all.length; i++) {
                    if(all[i].universalRegexToken != undefined) {
                        var x = 0;
                        var child = all[i];
                        while( (child = child.previousSibling) != null ){
                            x++
                        } 
                        var nextElement = all[i].nextSibling;
                        nextElement.nodeValue = highLightedText + nextElement.nodeValue;
                        var parentNode = all[i].parentNode;
                        all[i].remove();
                        editCount++;
                        parentNode.normalize();
                    }
                }
                window.highLightedText = undefined;
            }


            function highlightText(stringToHighlight) {
                var inner = document.getElementById("inner");
                // console.log("Children nodes:" ,inner.childNodes.length);
                // console.log("Highlight target:", stringToHighlight);

                var child = inner.childNodes[0];
                var x= 0;
                do{
                    x++
                    if(child.nodeValue == undefined || child.nodeValue == null) {
                        continue;
                    }
                    var splitIndex = child.nodeValue.indexOf(stringToHighlight);
                    if(splitIndex != -1) {
                        var nextText = child.splitText(
                            splitIndex
                        );
                        nextText.nodeValue = nextText.nodeValue.replace(stringToHighlight,"")
                        var newEl = document.createElement("p");
                        newEl.style.display = "inline";
                        newEl.universalRegexToken = true;
                        newEl.style.backgroundColor = "#58d68d";
                        newEl.innerText = stringToHighlight ;
                        inner.insertBefore(newEl,nextText);
                    } else {
                        console.log("Couldn't find...");
                    }
                } while( (child = child.nextSibling) != null );
                window.highLightedText = stringToHighlight;
            }


            // var butt = document.getElementById("cleanup");
            // butt.onclick = highlightButtonHandler;


            var searchContainer = document.createElement("div");
            searchContainer.style.display = "flex";
            searchContainer.style.flexDirection = "row";
            searchContainer.style.position = "fixed";
            searchContainer.style.top = 0;
            searchContainer.style.right = 0;
            searchContainer.id = "universalRegexContainer";
            var resultsContainer = document.createElement("div");
            searchContainer.appendChild(resultsContainer);
            var searchInput = document.createElement("input");
            searchInput.type = "text";
            searchInput.id = "universalRegexInput"
            searchInput.placeholder = "regex here";
            searchContainer.appendChild(searchInput);
            var regexSubmitButton = document.createElement("button");
            regexSubmitButton.innerHTML = "Search";
            regexSubmitButton.id = "regexSubmitButton";
            searchContainer.appendChild(regexSubmitButton);

            document.body.appendChild(searchContainer)
            regexSubmitButton.addEventListener('click', highlightButtonHandler);
        </script>
    </body>
</html>